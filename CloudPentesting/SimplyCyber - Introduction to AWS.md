### Configuring CloudGate on AWS
To configure Cloud Gate on AWS, we need to first install Terraform on Kali Linux. To do that, download the AMD64 Binary on Kali and then run the below script:
```
cd Downloads
unzip <filename>.zip
terraform -h
sudo cp terrform /usr/local/bin
```
And now terraform is accessible wherever we call it.

Then we are required to install jq using the command : `sudo apt install jq` 
And to install the Git repository using as Python Library, we will use the command : `pipx install git+https://github.com/RhinoSecurityLabs/cloudgoat.git `
```
â”Œâ”€â”€(shibushivanshã‰¿shibu)-[~/Scripts]
â””â”€$ pipx install git+https://github.com/RhinoSecurityLabs/cloudgoat.git
  installed package cloudgoat 2.3.1, installed using Python 3.13.9
  These apps are now globally available
    - cloudgoat
done! âœ¨ ðŸŒŸ âœ¨
```

Then we are required to create a user with some IAM Permissions. We'll go to Amazon Console > Users > Give Username > Attach Policy Directly > AdminstrativeAccess > Create User.

And then we will fetch the Access Key by creating them up.

Then use the command : `aws configure --profile shibu_cloadgoat` and enter the Access Key ID and Secret Access Key.
```
â”Œâ”€â”€(shibushivanshã‰¿shibu)-[~]
â””â”€$ aws sts get-caller-identity --profile shibu_cloudgoat
{
    "UserId": "AIDA6AIOUUF2USO2KZCF6",
    "Account": "962640257397",
    "Arn": "arn:aws:iam::962640257397:user/shibu_cloudgoat"
}

â”Œâ”€â”€(shibushivanshã‰¿shibu)-[~]
â””â”€$ cloudgoat config aws
No configuration file was found at /home/shibushivansh/.local/share/pipx/venvs/cloudgoat/lib/python3.13/site-packages/cloudgoat/config.yml.
Would you like to create this file with a default aws setting now? [y/n]: y
Enter the name of your default AWS profile: shibu_cloudgoat
A default aws setting of "shibu_cloudgoat" has been saved.

â”Œâ”€â”€(shibushivanshã‰¿shibu)-[~]
â””â”€$ cloudgoat config whitelist --auto
No whitelist.txt file was found at /home/shibushivansh/.local/share/pipx/venvs/cloudgoat/lib/python3.13/site-packages/cloudgoat/whitelist.txt

CloudGoat can automatically make a network request, using https://ifconfig.co to find your IP address, and then overwrite the contents of the whitelist file with the result.
Would you like to continue? [y/n]: y

whitelist.txt created with IP address 115.241.35.34/32

```

And using all these 3 commands, finally CloudGoat is installed and ready to work for us.

### Installing Pacu on Kali
To install Pacu on Kali, we use the command : `pipx install git+https://github.com/RhinoSecurityLabs/pacu.git`
```
â”Œâ”€â”€(shibushivanshã‰¿shibu)-[~/Scripts]
â””â”€$ pipx install git+https://github.com/RhinoSecurityLabs/pacu.git
âš ï¸  Note: pacu was already on your PATH at /usr/bin/pacu
  installed package pacu 1.6.1, installed using Python 3.13.9
  These apps are now globally available
    - pacu
done! âœ¨ ðŸŒŸ âœ¨
```

### IAM For Pentesters

Things we need to check for :
- **Privilege Escalation**  
    Can I go from a low-privilege user to an admin? This is the most common and most impactful finding in cloud environments.
- **Lateral Movement**  
    Even if I canâ€™t get admin access, can I move sideways into another user, role, or resource with sensitive accessâ€”like an S3 bucket full of data?
- **Data Exfiltration**  
    Can I take over a Lambda function and send data to my own server?
- **Persistence**  
    If I can create access keys for another user, I can quietly backdoor their account without changing their password. That kind of access is hard to detect unless youâ€™ve got solid logging and alerting in place.

When youâ€™re reviewing IAM permissions, here are four things you should always check:

1. **Users with excessive permissions**
2. **Roles that can be assumed**
3. **Policies that use wildcards** (e.g., `"Action": "*"` or `"Resource": "*"`)
4. **Services or Lambda functions with elevated permissions** that you can potentially abuse

![[Pasted image 20251217143842.png]]
Now here we can see that the user has the privilege of doing any action to any resource because of the presence of * in there.

IAM Enumeration Cheat Sheet
1. List IAM Users : `aws iam list-users`

2. Get User Permissions: 
	1. List attached managed policies: `aws iam list-attached-user-policies --user-name [user-name]`
	2. List inline policies : `aws iam list-user-policies --user-name [user-name]`
	3. Get inline policy details : `aws iam get-user-policy --user-name [user-name] --policy-name [policy-name]`

3. List IAM Groups and Permissions
	1. List groups for a user : `aws iam list-groups-for-user --user-name [user-name]`
	2. List group policies : `aws iam list-attached-group-policies --group-name [group-name] aws iam list-group-policies --group-name [group-name]`
	3. Get inline group policy details : `aws iam get-group-policy --group-name [group-name] --policy-name [policy-name]`

4. List IAM Roles and Permissions
	1. List all roles : `aws iam list-roles`
	2. Get role details (trust policy) : `aws iam get-role --role-name [role-name]`
	3. List attached policies : `aws iam list-attached-role-policies --role-name [role-name]`
	4. List inline policies : `aws iam list-role-policies --role-name [role-name]`
	5. Get inline role policy details : `aws iam get-role-policy --role-name [role-name] --policy-name [policy-name]`

5. Get and Decode Policy Documents : 
	1. Get a managed policy document (by ARN or name) : `aws iam get-policy --policy-arn [policy-arn] aws iam get-policy-version --policy-arn [policy-arn] --version-id [version-id]`
6. View Full IAM Snapshot
	1. Dump all IAM permissions (users, roles, groups, policies) : `aws iam get-account-authorization-details`
    >Use this to build a full IAM permissions map. Add --filter to target roles/users/groups specifically.
    

### S3 for Pentesters
1. List Buckets in the Authenticated Account : `aws s3 ls`
2. Check if a Bucket Exists (No Auth) : `aws s3 ls s3://[bucket-name] --no-sign-request`
3. List Contents of a Public or Accessible Bucket : `aws s3 ls s3://[bucket-name]/[optional-path] --no-sign-request`
4. Download an Object : `aws s3 cp s3://[bucket-name]/[key] [local-file] --no-sign-request`
5. Upload a File (Test Write Access) : `aws s3 cp test.txt s3://[bucket-name]/test.txt` ( Only works if write access is allowed.)
6. Enumerate Bucket Permissions (Authenticated) : 
	a. Get bucket policy : `aws s3api get-bucket-policy --bucket [bucket-name]`
	b. Get bucket ACL (Access Control List) : `aws s3api get-bucket-acl --bucket [bucket-name]`
	c. Get Public Access Block settings : `aws s3api get-bucket-public-access-block --bucket [bucket-name]`
	d. Get CORS configuration (may hint at XSS vectors) : `aws s3api get-bucket-cors --bucket [bucket-name]`

7. List All Buckets & Objects (If Compromised Creds):
```
aws s3api list-buckets
aws s3api list-objects --bucket [bucket-name] --output table
```

### Lambda Functions
![[Pasted image 20251218134823.png]]
#### Lambda Checklist
**1. List All Lambda Functions**
`aws lambda list-functions --region [region]`
Shows names, runtimes, ARNs, and last modified dates.

**2. Get Detailed Info on a Function**
a. Get full function config (IAM role, runtime, env vars, etc.)`
aws lambda get-function-configuration --function-name [function-name]`
b. Get code download URL + deployment details
`aws lambda get-function --function-name [function-name]`
Returns a pre-signed S3 URL to download the function code.

**3. Check Invocation Access**
a. Who/what can invoke the function (resource-based policy)?
aws lambda get-policy --function-name [function-name]
Look for `"Principal": "*"` or cross-account permissions.

**4. Identify Triggers / Event Sources**
a. For async event sources like SQS, DynamoDB, Kinesis:
`aws lambda list-event-source-mappings --function-name [function-name]`
b. For function URLs (direct HTTP endpoints) : 
`aws lambda get-function-url-config --function-name [function-name]`
If `AuthType` is `NONE`, it may be publicly invokable!

### **5. Invoke the Function (if allowed)**
`aws lambda invoke --function-name [function-name] output.json`

Add `--payload` if the function expects input:

--payload '{"key": "value"}'

---

**6. Investigate Attached IAM Role**
a. Get the role name from `get-function-configuration`
Then enumerate:
```
aws iam get-role --role-name [role-name]
aws iam list-attached-role-policies --role-name [role-name]
aws iam list-role-policies --role-name [role-name]
```
Look for overly permissive actions (`*`, `PassRole`, `SecretsManager`, etc.)

**7. Modify or Replace the Function (if you have perms)**
a. Update function code
`aws lambda update-function-code --function-name [function-name] --zip-file fileb://payload.zip`
b. Update configuration (e.g., env variables)
`aws lambda update-function-configuration --function-name [function-name] --environment "Variables={VAR=value}"`
Useful for persistence, exfil, or command injection if roles are over-permissioned.

>In Lambda Functions, always check out for the Environment Variables, because there is a hell lot of chance for us to find Access Keys in there.

**Enumerating Lambda Functions of CloudGoat**
Outputs are present in this page : [[CloudGoat]]
`aws lambda list-functions --region us-east-1 --profile cloud_goat_ec2 `
First, I used this command to know everything present in it. And I've stored the results in : [[CloudGoat]]
And then I've used this particular command : `aws lambda get-function --function-name cg-lambda-cgid023pfbwxkk --profile cloud_goat_ec2`

This is all for the manual exploitation because we are able to download all the files just using the CLI, only because we had some credentials present.

Then we can use Pacu for automated enumeration, here i just need to first do `import_key <profile_name>` and then search for `lambda__enum` using `search lambda__enum` and then we can run that particular module using the command : `run lambda__enum`. Then the output is present in the file mentioned above containing secrets and link to download the whole file present.

Then I was to gather information regarding Permission of EC2 and that I was able to take out using a module named `ec2__enum`, I'll put the output in another file.

Now, we have successfully enumerated all the permissions present for the CloudGoat account. And now to remove Lambda Function configuration made by CloudGoat, we can simply use the command : 
`cloudgoat destroy ec2_ssrf`


### EC2 - Elastic Compute Cloud
![[Pasted image 20251219170759.png]]
![[Pasted image 20251219171456.png]]

**EC2 Cheatsheet**

1. List EC2 Instances : `aws ec2 describe-instances --region [region]` Shows instance IDs, public IPs, AMIs, key names, IAM roles, etc. Use JMESPath filters for cleaner output:`aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId,PublicIpAddress,State.Name,KeyName,IamInstanceProfile.Arn]"`

2. Get Detailed Info on a Specific Instance : `aws ec2 describe-instances --instance-ids [i-xxxxxxxxxxxxxxx]`

3. Identify IAM Role Attached to the Instance : `aws ec2 describe-instances --query "Reservations[*].Instances[*].IamInstanceProfile.Arn"` Then grab role name and enumerate permissions : `aws iam get-instance-profile --instance-profile-name [name]`

4. List Security Groups : `aws ec2 describe-security-groups` | Look for open ports, especially 0.0.0.0/0 on SSH (22), RDP (3389), or custom ports.

	a. Check for overly permissive inbound rules: `aws ec2 describe-security-groups --query "SecurityGroups[*].IpPermissions[*].{From:FromPort,To:ToPort,CIDR:IpRanges}"`

5. Describe Network Interfaces : `aws ec2 describe-network-interfaces`
    See public/private IPs, subnet info, VPC IDs, attachment info.

6. List AMIs (Amazon Machine Images) : `aws ec2 describe-images --owners self` | Use this to find custom images that may contain secrets or sensitive software.

7. Check EBS Volume Info : `aws ec2 describe-volumes` | Look for unencrypted volumes, large or attached volumes.

	a. Snapshot enumeration (potential data leaks):  `aws ec2 describe-snapshots --owner-ids self`

8. Enumerate Key Pairs : `aws ec2 describe-key-pairs`

    You can't get private keys from AWS, but public names may hint at user naming patterns or poor key hygiene.

9. Describe Regions & Availability Zones : 
```
aws ec2 describe-regions aws ec2 describe-availability-zones`
```

> If you see an EC2 Instance running in an AWS Console, we can extract User Data present in there, and there is a possibility for us to find credentials.


As CloudGoat is already configured over AWS, hence we can directly use it. First we checked the results of `aws sts get-caller-identity --profile profilename` and after that we want to enumerate information about EC2 Instance.

Then we used to command `aws ec2 confi`

These commands make the output too long, making it really chaotic to read and understand hence we can use the command like this `aws des` to just get the direct output of what we need
